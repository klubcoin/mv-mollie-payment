package io.liquichain.api.payment;

import com.fasterxml.jackson.core.type.TypeReference;
import com.fasterxml.jackson.databind.ObjectMapper;
import org.meveo.commons.utils.ParamBean;
import org.meveo.commons.utils.ParamBeanFactory;
import org.meveo.service.script.Script;

import java.util.Map;

import org.meveo.admin.exception.BusinessException;
import org.meveo.model.customEntities.MoOrder;
import org.meveo.model.storage.Repository;
import org.meveo.service.storage.RepositoryService;
import org.meveo.api.persistence.CrossStorageApi;

import org.slf4j.Logger;
import org.slf4j.LoggerFactory;

public class CheckoutPage extends Script {
    private static final Logger LOG = LoggerFactory.getLogger(CheckoutPage.class);
    private static final ObjectMapper mapper = new ObjectMapper();

    private final CrossStorageApi crossStorageApi = getCDIBean(CrossStorageApi.class);
    private final RepositoryService repositoryService = getCDIBean(RepositoryService.class);
    private final ParamBeanFactory paramBeanFactory = getCDIBean(ParamBeanFactory.class);
    private Repository defaultRepo;

    private String APP_NAME;

    private String result;
    private String orderId;

    public void setOrderId(String orderId) {
        this.orderId = orderId;
    }

    public String getResult() {
        return result;
    }

    private void init() {
        defaultRepo = repositoryService.findDefaultRepository();
        ParamBean config = paramBeanFactory.getInstance();
        APP_NAME = config.getProperty("app.name", "Liquichain");
    }

    @Override
    public void execute(Map<String, Object> parameters) throws BusinessException {
        this.init();
        LOG.info("CheckoutPage parameters: {}", parameters);

        result = "<!DOCTYPE html>\r\n"
            + "<html lang=\"en\">\r\n"
            + "\t<head>\r\n"
            + "\t\t<style>\r\n"
            + "\t\t\tbody {background: #110e21;font-family: 'Poppins', sans-serif;font-weight: 500;color: #fff;}\r\n"
            + "\t\t\tsection {background: #0b0917;border-bottom: 2px solid #ec00f8;"
            + "box-shadow: 0 6px 20px 0 rgba(0, 0, 0, 0.19);color: #fff;padding: 1em;position: absolute;top: 50%;"
            + "left: 50%;margin-right: -50%;transform: translate(-50%, -50%);text-align: center;}\r\n"
            + "\t\t\th1 {color: #00f3bd;font-weight: 600;}\r\n"
            + "</style>\r\n"
            + "\t\t<meta charset=\"utf-8\">\r\n"
            + "\t\t<title>" + APP_NAME + " Checkout</title>\r\n"
            + "\t</head>\r\n"
            + "\t<body><section>\r\n"
            + "\t<div>\n"
            + "\t\t<svg id=\"svg\" xmlns=\"http://www.w3.org/2000/svg\" xmlns:xlink=\"http://www.w3.org/1999/xlink\" width=\"300\" height=\"84\" viewBox=\"0, 0, 400,112.35955056179775\" version=\"1.1\"><g id=\"svgg\"><path id=\"path0\" d=\"M48.083 4.755 C 47.717 4.876,47.073 4.980,46.653 4.987 C 46.233 4.994,45.833 5.056,45.764 5.125 C 45.695 5.193,45.139 5.345,44.528 5.461 C 42.348 5.876,42.079 5.941,41.719 6.136 C 41.519 6.245,41.167 6.333,40.937 6.333 C 40.708 6.333,40.477 6.402,40.426 6.485 C 40.374 6.569,40.032 6.688,39.667 6.750 C 39.301 6.812,38.959 6.931,38.908 7.015 C 38.856 7.098,38.671 7.167,38.496 7.167 C 38.321 7.167,37.894 7.290,37.547 7.441 C 36.953 7.699,36.618 7.840,35.417 8.339 C 34.378 8.770,33.742 9.053,33.500 9.192 C 33.362 9.271,33.137 9.378,33.000 9.430 C 32.862 9.482,32.600 9.608,32.417 9.710 C 32.233 9.812,31.633 10.147,31.083 10.453 C 30.533 10.759,29.877 11.090,29.625 11.188 C 29.373 11.286,29.167 11.434,29.167 11.516 C 29.167 11.599,29.056 11.667,28.922 11.667 C 28.660 11.667,27.372 12.503,26.674 13.125 C 26.443 13.331,26.188 13.500,26.109 13.500 C 25.970 13.500,25.615 13.760,23.109 15.700 C 21.893 16.642,16.167 22.174,16.167 22.407 C 16.167 22.484,15.754 23.016,15.250 23.590 C 14.746 24.165,14.333 24.685,14.333 24.746 C 14.333 24.807,14.033 25.213,13.667 25.647 C 13.300 26.082,13.000 26.495,13.000 26.564 C 13.000 26.634,12.906 26.795,12.792 26.923 C 12.373 27.389,12.167 27.654,12.167 27.724 C 12.167 27.763,11.867 28.245,11.500 28.794 C 11.133 29.343,10.833 29.858,10.833 29.938 C 10.832 30.018,10.608 30.421,10.333 30.833 C 10.059 31.246,9.834 31.689,9.834 31.818 C 9.834 31.946,9.646 32.298,9.417 32.598 C 9.188 32.899,9.000 33.218,9.000 33.309 C 9.000 33.399,8.894 33.685,8.765 33.945 C 8.635 34.204,8.328 34.867,8.082 35.417 C 7.836 35.967,7.530 36.616,7.401 36.859 C 7.272 37.102,7.167 37.413,7.167 37.548 C 7.167 37.684,7.055 38.010,6.918 38.273 C 6.781 38.535,6.668 38.877,6.668 39.032 C 6.667 39.187,6.592 39.360,6.500 39.417 C 6.408 39.473,6.333 39.673,6.333 39.860 C 6.333 40.047,6.228 40.436,6.099 40.725 C 5.969 41.014,5.824 41.438,5.775 41.667 C 5.726 41.896,5.563 42.533,5.412 43.083 C 5.262 43.633,5.080 44.383,5.008 44.750 C 4.936 45.117,4.796 45.754,4.698 46.167 C 4.342 47.657,4.123 49.283,4.047 51.000 C 4.004 51.962,3.882 52.855,3.776 52.984 C 3.488 53.333,3.410 58.855,3.683 59.549 C 3.799 59.843,3.946 60.833,4.011 61.750 C 4.154 63.795,4.446 65.805,4.762 66.931 C 4.893 67.398,5.000 67.975,5.000 68.213 C 5.000 68.452,5.075 68.693,5.167 68.750 C 5.258 68.807,5.333 69.027,5.333 69.241 C 5.333 69.610,5.652 70.843,6.026 71.917 C 6.122 72.192,6.237 72.604,6.282 72.833 C 6.366 73.262,6.727 74.194,7.008 74.706 C 7.095 74.865,7.167 75.116,7.167 75.264 C 7.167 75.411,7.270 75.731,7.397 75.974 C 7.524 76.218,7.742 76.679,7.880 77.000 C 8.019 77.321,8.320 77.996,8.548 78.500 C 8.777 79.004,9.011 79.529,9.069 79.667 C 9.127 79.804,9.473 80.442,9.838 81.083 C 10.203 81.725,10.593 82.456,10.704 82.708 C 10.815 82.960,10.965 83.167,11.037 83.167 C 11.108 83.167,11.167 83.268,11.167 83.392 C 11.167 83.515,11.392 83.927,11.667 84.307 C 11.942 84.687,12.167 85.039,12.167 85.089 C 12.167 85.140,12.354 85.383,12.583 85.631 C 12.813 85.878,13.000 86.145,13.000 86.224 C 13.000 86.304,13.225 86.653,13.500 87.000 C 13.775 87.347,14.000 87.680,14.000 87.740 C 14.000 87.799,14.257 88.126,14.571 88.466 C 14.886 88.805,15.386 89.421,15.684 89.833 C 16.433 90.870,21.547 95.961,22.667 96.784 C 23.171 97.154,23.793 97.655,24.050 97.895 C 24.307 98.136,24.559 98.333,24.610 98.333 C 24.660 98.333,24.986 98.558,25.333 98.833 C 25.681 99.108,26.030 99.333,26.109 99.333 C 26.188 99.333,26.456 99.521,26.703 99.750 C 26.950 99.979,27.220 100.167,27.303 100.167 C 27.386 100.167,27.737 100.392,28.083 100.667 C 28.429 100.942,28.815 101.167,28.940 101.167 C 29.064 101.167,29.167 101.242,29.167 101.333 C 29.167 101.425,29.252 101.500,29.357 101.500 C 29.462 101.500,30.022 101.800,30.603 102.167 C 31.183 102.533,31.764 102.833,31.892 102.833 C 32.021 102.833,32.219 102.946,32.333 103.083 C 32.447 103.221,32.672 103.333,32.833 103.333 C 32.994 103.333,33.219 103.446,33.333 103.583 C 33.447 103.721,33.645 103.833,33.773 103.833 C 33.900 103.833,34.135 103.897,34.294 103.975 C 34.453 104.054,34.883 104.250,35.250 104.411 C 35.617 104.573,36.116 104.809,36.359 104.936 C 36.602 105.063,36.910 105.167,37.042 105.167 C 37.264 105.167,38.019 105.474,38.706 105.844 C 38.865 105.930,39.165 106.000,39.373 106.001 C 39.580 106.002,39.965 106.114,40.227 106.251 C 40.490 106.388,40.906 106.500,41.152 106.500 C 41.399 106.500,41.674 106.574,41.765 106.665 C 41.921 106.821,42.605 106.998,44.333 107.328 C 44.746 107.407,45.294 107.553,45.553 107.652 C 45.811 107.752,46.339 107.833,46.726 107.833 C 47.113 107.833,47.862 107.946,48.390 108.083 C 48.918 108.221,49.965 108.336,50.716 108.339 C 51.586 108.343,52.235 108.432,52.500 108.583 C 53.114 108.934,58.554 108.933,59.227 108.582 C 59.527 108.426,60.177 108.332,60.977 108.331 C 61.677 108.329,62.700 108.219,63.250 108.087 C 63.800 107.954,64.550 107.841,64.917 107.837 C 65.283 107.832,65.883 107.720,66.250 107.588 C 66.617 107.456,67.185 107.345,67.514 107.341 C 67.842 107.337,68.165 107.280,68.230 107.214 C 68.363 107.082,69.559 106.723,70.583 106.509 C 71.249 106.369,72.190 106.065,72.672 105.832 C 72.813 105.764,73.185 105.652,73.500 105.583 C 74.102 105.451,74.184 105.418,75.250 104.866 C 76.230 104.359,76.206 103.954,75.127 102.745 C 74.638 102.198,73.979 101.412,73.662 101.000 C 73.345 100.587,72.860 100.000,72.584 99.694 C 72.309 99.387,72.018 99.021,71.937 98.879 C 71.857 98.737,71.655 98.462,71.489 98.268 C 71.322 98.075,70.993 97.692,70.756 97.417 C 70.520 97.142,70.163 96.681,69.964 96.393 C 69.764 96.104,69.316 95.743,68.969 95.590 C 68.314 95.301,68.320 95.300,66.667 95.847 C 65.974 96.076,65.140 96.260,63.667 96.510 C 63.071 96.612,62.321 96.763,62.000 96.848 C 60.107 97.346,50.756 97.327,49.815 96.823 C 49.654 96.737,49.198 96.663,48.803 96.659 C 48.407 96.655,47.783 96.544,47.417 96.412 C 47.050 96.280,46.573 96.171,46.356 96.169 C 46.000 96.167,44.790 95.827,43.917 95.484 C 43.733 95.412,43.323 95.301,43.005 95.239 C 42.409 95.121,42.280 95.070,41.391 94.607 C 41.102 94.457,40.765 94.333,40.643 94.333 C 40.439 94.333,38.915 93.661,38.333 93.314 C 38.196 93.232,37.971 93.122,37.833 93.070 C 37.696 93.018,37.447 92.902,37.279 92.812 C 36.246 92.256,35.691 91.939,35.250 91.653 C 34.975 91.475,34.619 91.284,34.458 91.229 C 34.298 91.173,34.167 91.062,34.167 90.981 C 34.167 90.900,34.057 90.833,33.922 90.833 C 33.788 90.833,33.422 90.608,33.109 90.333 C 32.796 90.058,32.479 89.833,32.405 89.833 C 32.332 89.833,31.916 89.533,31.481 89.167 C 31.046 88.800,30.627 88.500,30.550 88.500 C 30.160 88.500,25.204 83.492,24.035 81.917 C 23.967 81.825,23.594 81.370,23.206 80.906 C 22.818 80.442,22.499 79.992,22.497 79.906 C 22.496 79.820,22.271 79.496,21.997 79.186 C 21.724 78.875,21.500 78.519,21.500 78.394 C 21.500 78.269,21.432 78.167,21.348 78.167 C 21.265 78.167,21.035 77.848,20.837 77.458 C 20.639 77.069,20.255 76.375,19.983 75.917 C 19.712 75.458,19.449 74.971,19.399 74.833 C 19.350 74.696,19.239 74.471,19.154 74.333 C 19.068 74.196,18.954 73.971,18.901 73.833 C 18.848 73.696,18.623 73.207,18.402 72.748 C 18.181 72.288,18.000 71.812,18.000 71.690 C 18.000 71.568,17.877 71.232,17.726 70.942 C 17.268 70.062,17.214 69.927,17.083 69.333 C 17.014 69.019,16.901 68.646,16.832 68.505 C 16.667 68.171,16.344 66.943,16.173 66.000 C 16.098 65.587,15.953 64.988,15.852 64.668 C 15.750 64.348,15.667 63.799,15.667 63.448 C 15.667 63.098,15.599 62.685,15.516 62.531 C 14.968 61.506,14.949 50.966,15.494 50.250 C 15.564 50.158,15.667 49.564,15.724 48.928 C 15.780 48.293,15.903 47.697,15.997 47.603 C 16.090 47.510,16.167 47.215,16.167 46.947 C 16.167 46.516,16.477 45.364,16.850 44.417 C 16.922 44.233,17.032 43.823,17.095 43.505 C 17.213 42.909,17.263 42.780,17.726 41.891 C 17.877 41.602,18.000 41.265,18.000 41.143 C 18.000 40.939,18.673 39.415,19.020 38.833 C 19.102 38.696,19.211 38.471,19.263 38.333 C 19.315 38.196,19.431 37.947,19.521 37.779 C 19.611 37.612,19.844 37.162,20.038 36.779 C 20.233 36.397,20.547 35.859,20.738 35.584 C 20.928 35.309,21.225 34.822,21.397 34.501 C 21.570 34.179,21.855 33.729,22.030 33.500 C 22.205 33.271,22.886 32.371,23.543 31.500 C 24.697 29.971,29.823 24.667,30.147 24.667 C 30.234 24.667,30.627 24.367,31.020 24.000 C 31.414 23.633,31.814 23.332,31.909 23.330 C 32.005 23.328,32.361 23.085,32.701 22.788 C 33.040 22.492,33.678 22.063,34.117 21.833 C 34.557 21.604,34.954 21.372,35.000 21.317 C 35.291 20.967,37.059 20.163,37.340 20.252 C 37.713 20.370,37.870 44.688,37.500 44.917 C 37.122 45.150,37.288 77.887,37.669 78.213 C 37.973 78.473,38.577 78.500,44.177 78.500 L 50.349 78.500 50.758 78.059 L 51.167 77.618 51.167 69.298 C 51.167 63.600,51.109 60.871,50.985 60.638 C 50.884 60.451,50.866 60.236,50.943 60.161 C 51.118 59.991,52.167 60.419,52.167 60.661 C 52.167 60.833,52.976 61.891,54.392 63.570 C 54.772 64.021,55.196 64.560,55.333 64.767 C 55.471 64.974,56.015 65.626,56.542 66.215 C 57.069 66.805,57.500 67.369,57.500 67.469 C 57.500 67.568,57.596 67.710,57.714 67.783 C 57.832 67.857,58.358 68.442,58.884 69.083 C 59.410 69.725,60.010 70.438,60.217 70.667 C 60.425 70.896,60.815 71.383,61.085 71.750 C 61.354 72.117,62.083 73.000,62.704 73.714 C 63.325 74.428,63.836 75.065,63.840 75.131 C 63.843 75.196,64.256 75.699,64.756 76.247 C 65.257 76.795,65.667 77.299,65.667 77.366 C 65.667 77.433,65.873 77.704,66.125 77.968 C 66.667 78.536,67.045 78.987,67.830 80.001 C 68.149 80.413,68.655 81.012,68.954 81.333 C 69.253 81.654,69.498 81.973,69.499 82.042 C 69.499 82.110,69.631 82.299,69.792 82.461 C 70.037 82.708,71.722 84.712,72.136 85.250 C 72.652 85.918,74.000 87.567,74.635 88.306 C 75.056 88.794,75.479 89.331,75.575 89.497 C 75.671 89.664,76.220 90.351,76.795 91.025 C 78.746 93.314,79.037 93.668,79.548 94.376 C 79.829 94.765,80.147 95.158,80.255 95.250 C 80.364 95.342,80.961 96.054,81.584 96.833 C 83.970 99.821,84.715 100.263,85.667 99.250 C 85.882 99.021,86.131 98.833,86.220 98.833 C 86.309 98.833,86.723 98.552,87.138 98.208 C 87.554 97.865,87.988 97.546,88.103 97.500 C 88.283 97.428,90.361 95.586,93.029 93.133 C 93.458 92.739,93.871 92.294,93.946 92.145 C 94.022 91.996,94.646 91.258,95.333 90.505 C 96.021 89.752,96.621 89.044,96.667 88.932 C 96.712 88.820,97.024 88.395,97.359 87.989 C 97.975 87.241,99.833 84.539,99.833 84.391 C 99.833 84.347,100.002 84.072,100.209 83.781 C 100.730 83.044,100.881 82.781,101.712 81.167 C 102.113 80.387,102.524 79.600,102.626 79.417 C 102.790 79.121,103.154 78.332,104.061 76.308 C 104.211 75.973,104.333 75.616,104.333 75.514 C 104.333 75.326,104.394 75.182,104.888 74.195 C 105.041 73.889,105.169 73.477,105.173 73.278 C 105.176 73.079,105.286 72.729,105.417 72.500 C 105.548 72.271,105.658 71.882,105.661 71.635 C 105.664 71.388,105.742 71.140,105.833 71.083 C 105.925 71.027,106.000 70.816,106.001 70.615 C 106.002 70.414,106.114 70.035,106.251 69.773 C 106.388 69.510,106.500 69.046,106.500 68.742 C 106.500 68.437,106.587 67.977,106.693 67.719 C 106.799 67.461,106.947 66.837,107.021 66.333 C 107.095 65.829,107.282 64.629,107.436 63.667 C 107.658 62.283,107.717 60.767,107.717 56.417 C 107.717 52.067,107.658 50.551,107.436 49.167 C 107.282 48.204,107.100 47.004,107.033 46.500 C 106.965 45.996,106.847 45.485,106.772 45.366 C 106.697 45.246,106.572 44.758,106.495 44.282 C 106.418 43.806,106.231 43.004,106.080 42.500 C 105.928 41.996,105.743 41.358,105.667 41.083 C 105.518 40.542,105.199 39.616,104.979 39.083 C 104.903 38.900,104.719 38.375,104.571 37.917 C 104.422 37.458,104.187 36.821,104.049 36.500 C 103.533 35.305,103.276 34.737,103.029 34.250 C 102.594 33.394,102.533 33.271,102.175 32.500 C 101.983 32.087,101.608 31.375,101.342 30.917 C 101.075 30.458,100.704 29.804,100.517 29.464 C 100.144 28.782,99.694 28.085,98.674 26.608 C 98.303 26.072,98.000 25.569,98.000 25.491 C 98.000 25.414,97.906 25.290,97.792 25.217 C 97.551 25.063,96.167 23.402,96.167 23.267 C 96.167 22.653,87.369 14.345,86.704 14.331 C 86.638 14.329,86.246 14.030,85.833 13.667 C 85.421 13.303,85.020 13.004,84.942 13.003 C 84.865 13.001,84.566 12.831,84.279 12.625 C 83.699 12.209,83.211 11.906,82.833 11.729 C 82.696 11.665,82.365 11.461,82.097 11.275 C 81.420 10.805,76.824 8.500,76.564 8.500 C 76.447 8.500,75.998 8.312,75.567 8.083 C 75.136 7.854,74.659 7.667,74.507 7.667 C 74.355 7.667,74.085 7.557,73.907 7.422 C 73.729 7.287,73.419 7.175,73.218 7.172 C 73.017 7.169,72.807 7.092,72.750 7.000 C 72.693 6.908,72.520 6.833,72.365 6.832 C 72.210 6.832,71.869 6.719,71.606 6.582 C 71.343 6.445,70.945 6.333,70.720 6.333 C 70.495 6.333,70.148 6.244,69.947 6.135 C 69.747 6.025,69.246 5.879,68.833 5.809 C 68.421 5.740,67.596 5.560,67.000 5.410 C 66.404 5.260,65.368 5.068,64.697 4.985 C 64.026 4.901,63.337 4.758,63.166 4.666 C 62.995 4.575,62.187 4.500,61.370 4.500 C 59.188 4.500,59.333 4.101,59.333 10.112 C 59.333 16.262,58.909 15.564,63.000 16.144 C 63.833 16.262,64.482 16.415,65.917 16.834 C 66.192 16.914,66.699 17.030,67.044 17.092 C 67.388 17.154,67.711 17.271,67.762 17.352 C 67.812 17.434,68.057 17.500,68.306 17.500 C 68.555 17.500,68.907 17.596,69.088 17.714 C 69.269 17.832,69.717 18.028,70.083 18.150 C 70.899 18.421,71.831 18.808,72.167 19.015 C 72.304 19.100,72.529 19.214,72.667 19.269 C 72.804 19.324,73.153 19.473,73.442 19.601 C 73.731 19.729,74.024 19.833,74.093 19.833 C 74.162 19.833,74.464 20.021,74.765 20.250 C 75.065 20.479,75.419 20.667,75.552 20.667 C 75.684 20.667,75.886 20.779,76.000 20.917 C 76.114 21.054,76.285 21.167,76.380 21.167 C 76.474 21.167,76.798 21.354,77.098 21.583 C 77.399 21.813,77.685 22.000,77.734 22.000 C 77.868 22.000,79.345 23.029,79.826 23.458 C 80.057 23.665,80.322 23.833,80.415 23.833 C 80.693 23.833,84.863 27.666,85.750 28.736 C 85.933 28.958,86.555 29.689,87.131 30.361 C 87.708 31.033,88.233 31.658,88.300 31.750 C 88.366 31.842,88.663 32.227,88.960 32.607 C 89.257 32.987,89.500 33.347,89.500 33.406 C 89.500 33.465,89.654 33.679,89.842 33.881 C 90.030 34.083,90.349 34.586,90.550 34.999 C 90.752 35.412,90.972 35.792,91.041 35.843 C 91.229 35.983,93.500 40.531,93.500 40.767 C 93.500 40.881,93.625 41.223,93.778 41.528 C 94.232 42.434,94.285 42.569,94.408 43.129 C 94.473 43.422,94.595 43.706,94.679 43.758 C 94.764 43.810,94.833 44.041,94.833 44.271 C 94.833 44.501,94.910 44.833,95.005 45.009 C 95.179 45.335,95.386 46.193,95.687 47.833 C 95.779 48.337,95.922 48.900,96.004 49.083 C 96.086 49.267,96.190 49.904,96.233 50.500 C 96.277 51.096,96.388 52.146,96.480 52.833 C 96.694 54.442,96.694 58.392,96.480 60.000 C 96.388 60.688,96.277 61.737,96.233 62.333 C 96.190 62.929,96.086 63.567,96.004 63.750 C 95.922 63.933,95.779 64.496,95.687 65.000 C 95.386 66.640,95.179 67.499,95.005 67.825 C 94.910 68.001,94.831 68.318,94.828 68.531 C 94.825 68.743,94.713 69.062,94.578 69.240 C 94.443 69.418,94.333 69.700,94.333 69.867 C 94.333 70.172,94.291 70.281,93.778 71.305 C 93.625 71.611,93.500 71.953,93.500 72.066 C 93.500 72.377,91.242 76.786,90.758 77.422 C 90.524 77.728,90.333 78.022,90.333 78.077 C 90.333 78.214,88.548 80.809,88.246 81.112 C 88.111 81.247,88.000 81.409,88.000 81.472 C 88.000 82.427,86.243 83.074,85.865 82.259 C 85.778 82.071,85.266 81.438,84.728 80.853 C 84.190 80.269,83.681 79.669,83.596 79.520 C 83.512 79.372,83.041 78.762,82.551 78.167 C 82.060 77.571,81.601 77.008,81.530 76.917 C 80.718 75.863,79.421 74.301,77.958 72.618 C 77.798 72.433,77.665 72.238,77.662 72.183 C 77.660 72.128,77.351 71.748,76.976 71.339 C 76.600 70.929,76.171 70.404,76.022 70.172 C 75.762 69.767,75.074 68.945,74.458 68.304 C 74.298 68.137,74.166 67.944,74.166 67.875 C 74.165 67.806,73.922 67.481,73.624 67.151 C 72.496 65.902,72.073 65.404,71.801 65.000 C 71.646 64.771,71.281 64.321,70.989 64.000 C 70.698 63.679,70.337 63.229,70.189 63.000 C 69.928 62.598,69.231 61.768,68.625 61.137 C 68.465 60.970,68.333 60.777,68.332 60.708 C 68.331 60.640,67.920 60.133,67.419 59.583 C 66.301 58.357,66.267 58.006,67.169 57.034 C 67.534 56.641,67.833 56.273,67.833 56.218 C 67.833 56.162,68.152 55.720,68.542 55.235 C 68.931 54.750,69.471 54.048,69.740 53.676 C 70.010 53.304,70.291 53.000,70.365 53.000 C 70.439 53.000,70.500 52.915,70.500 52.810 C 70.500 52.706,70.898 52.125,71.385 51.519 C 71.872 50.913,72.528 50.079,72.842 49.667 C 73.157 49.254,73.473 48.842,73.546 48.750 C 73.620 48.658,74.218 47.871,74.877 47.000 C 75.536 46.129,76.246 45.230,76.454 45.002 C 76.663 44.773,76.834 44.511,76.835 44.418 C 76.837 44.326,77.137 43.928,77.502 43.534 C 77.868 43.141,78.168 42.766,78.169 42.701 C 78.171 42.636,78.470 42.246,78.833 41.833 C 79.197 41.421,79.496 41.032,79.497 40.970 C 79.499 40.908,79.620 40.737,79.766 40.591 C 80.521 39.836,80.331 39.817,72.211 39.869 L 64.583 39.917 63.958 40.308 C 63.615 40.523,63.333 40.773,63.333 40.862 C 63.333 40.951,62.940 41.503,62.458 42.087 C 61.977 42.671,61.283 43.542,60.917 44.022 C 60.550 44.503,59.931 45.293,59.542 45.779 C 59.152 46.265,58.833 46.709,58.833 46.767 C 58.833 46.824,58.474 47.294,58.035 47.811 C 57.596 48.327,57.127 48.908,56.994 49.101 C 56.801 49.378,55.331 51.342,54.636 52.250 C 54.565 52.342,54.107 52.904,53.617 53.500 C 53.128 54.096,52.594 54.808,52.433 55.083 C 51.881 56.021,50.515 56.573,51.003 55.661 C 51.320 55.068,51.217 5.399,50.897 4.911 C 50.583 4.431,49.283 4.359,48.083 4.755 M137.167 57.997 L 137.167 80.833 141.667 80.833 L 146.167 80.833 146.171 75.792 L 146.175 70.750 147.925 68.958 C 148.888 67.973,149.736 67.167,149.810 67.167 C 149.939 67.167,151.000 68.552,151.000 68.721 C 151.000 68.767,151.412 69.418,151.917 70.167 C 152.421 70.916,152.833 71.579,152.833 71.641 C 152.833 71.703,153.002 71.942,153.208 72.173 C 153.415 72.403,153.733 72.890,153.916 73.254 C 154.099 73.619,154.324 74.008,154.416 74.119 C 154.508 74.231,154.677 74.434,154.792 74.571 C 154.906 74.707,155.000 74.886,155.000 74.967 C 155.000 75.048,155.188 75.333,155.418 75.599 C 155.647 75.865,155.882 76.228,155.938 76.404 C 155.995 76.580,156.189 76.880,156.370 77.071 C 156.551 77.261,156.770 77.567,156.856 77.750 C 157.078 78.218,157.356 78.672,157.792 79.279 C 157.998 79.566,158.169 79.865,158.172 79.942 C 158.206 80.792,158.477 80.833,163.985 80.833 C 166.835 80.833,169.167 80.783,169.167 80.721 C 169.167 80.578,168.013 78.864,167.627 78.432 C 167.468 78.254,167.290 77.958,167.231 77.774 C 167.173 77.591,166.947 77.249,166.729 77.014 C 166.512 76.779,166.333 76.536,166.333 76.474 C 166.333 76.412,165.934 75.768,165.445 75.043 C 164.957 74.317,164.504 73.617,164.439 73.487 C 164.239 73.087,163.934 72.601,163.542 72.054 C 163.335 71.767,163.167 71.487,163.167 71.431 C 163.167 71.376,162.941 71.012,162.665 70.624 C 161.778 69.375,161.701 69.264,161.096 68.358 C 160.768 67.868,160.500 67.429,160.500 67.382 C 160.500 67.336,160.275 67.014,160.000 66.667 C 159.725 66.319,159.500 65.986,159.500 65.926 C 159.500 65.866,159.219 65.390,158.876 64.867 C 158.532 64.344,158.213 63.842,158.167 63.750 C 157.972 63.366,156.754 61.566,156.552 61.363 C 155.852 60.659,156.274 60.164,165.794 50.546 C 167.284 49.040,168.461 47.739,168.409 47.654 C 168.300 47.477,158.227 47.461,157.823 47.637 C 157.679 47.699,157.032 48.350,156.384 49.083 C 155.737 49.817,154.668 50.973,154.010 51.653 C 153.351 52.334,152.662 53.084,152.478 53.320 C 152.085 53.825,148.550 57.614,148.125 57.986 C 147.965 58.126,147.833 58.322,147.833 58.421 C 147.833 58.704,146.765 59.667,146.451 59.667 C 146.189 59.667,146.166 58.809,146.126 47.458 L 146.083 35.250 141.625 35.206 L 137.167 35.161 137.167 57.997 M175.333 58.003 L 175.333 80.839 179.792 80.794 L 184.250 80.750 184.296 58.333 C 184.321 46.004,184.301 35.748,184.251 35.542 L 184.160 35.167 179.747 35.167 L 175.333 35.167 175.333 58.003 M233.333 58.000 L 233.333 80.833 237.875 80.833 L 242.417 80.833 242.360 78.625 C 242.314 76.826,242.344 76.455,242.519 76.625 C 242.637 76.740,242.866 76.833,243.027 76.833 C 243.189 76.833,243.411 77.002,243.520 77.208 C 243.730 77.607,244.780 78.664,244.970 78.670 C 245.032 78.672,245.370 78.923,245.719 79.228 C 246.341 79.771,247.836 80.577,249.000 80.997 C 251.377 81.855,256.318 81.669,258.373 80.644 C 258.532 80.565,258.742 80.500,258.840 80.500 C 259.263 80.500,261.415 79.349,262.111 78.750 C 262.974 78.008,265.167 75.727,265.167 75.570 C 265.167 75.462,265.272 75.287,265.401 75.179 C 265.530 75.072,265.757 74.744,265.906 74.451 C 266.054 74.157,266.244 73.804,266.328 73.667 C 266.658 73.123,267.302 71.552,267.419 71.005 C 267.487 70.688,267.604 70.313,267.679 70.172 C 267.755 70.032,267.862 69.562,267.918 69.129 C 267.974 68.696,268.090 68.297,268.176 68.244 C 268.379 68.119,268.385 60.385,268.182 60.260 C 268.099 60.208,267.981 59.773,267.920 59.291 C 267.811 58.438,267.457 57.209,267.152 56.627 C 267.068 56.468,267.000 56.234,267.000 56.106 C 267.000 55.978,266.887 55.781,266.750 55.667 C 266.612 55.553,266.500 55.359,266.500 55.236 C 266.500 53.984,261.348 48.500,260.172 48.500 C 260.105 48.500,259.719 48.324,259.315 48.109 C 258.911 47.895,258.281 47.663,257.915 47.595 C 257.549 47.526,257.175 47.411,257.083 47.339 C 256.366 46.773,250.537 46.842,249.225 47.431 C 248.936 47.561,248.628 47.667,248.540 47.667 C 247.829 47.667,246.059 48.940,244.250 50.753 C 242.162 52.845,242.316 53.437,242.371 43.570 L 242.417 35.167 237.875 35.167 L 233.333 35.167 233.333 58.000 M353.167 38.133 C 353.167 40.135,353.193 40.167,354.846 40.167 C 356.430 40.167,356.432 40.164,356.364 38.125 L 356.310 36.500 354.739 36.500 L 353.167 36.500 353.167 38.133 M193.391 59.542 C 193.458 72.591,193.488 73.042,194.442 75.275 C 194.566 75.564,194.667 75.854,194.667 75.919 C 194.667 77.121,198.812 80.833,200.153 80.833 C 200.303 80.833,200.574 80.935,200.755 81.060 C 201.647 81.676,207.069 81.675,208.250 81.059 C 208.433 80.964,208.751 80.799,208.956 80.693 C 209.161 80.587,209.431 80.500,209.556 80.500 C 209.681 80.500,210.077 80.287,210.437 80.027 C 210.796 79.766,211.180 79.523,211.290 79.485 C 211.400 79.447,212.165 78.755,212.990 77.946 C 214.821 76.150,214.833 76.156,214.833 78.763 L 214.833 80.839 219.375 80.794 C 221.873 80.770,223.898 80.694,223.875 80.625 C 223.852 80.556,223.833 73.112,223.833 64.083 L 223.833 47.667 219.333 47.667 L 214.833 47.667 214.833 57.853 C 214.833 68.684,214.852 68.396,214.040 70.307 C 213.504 71.568,211.256 73.333,210.186 73.333 C 210.003 73.333,209.807 73.408,209.750 73.500 C 209.693 73.592,209.220 73.666,208.698 73.664 C 206.563 73.659,204.288 72.393,203.461 70.750 C 202.522 68.886,202.593 69.828,202.532 58.292 L 202.476 47.667 197.903 47.667 L 193.329 47.667 193.391 59.542 M288.023 48.757 C 287.714 48.890,287.285 49.000,287.070 49.000 C 286.854 49.000,286.394 49.122,286.047 49.272 C 284.761 49.826,282.828 50.823,282.667 51.017 C 282.621 51.072,282.486 51.148,282.367 51.186 C 281.554 51.446,278.525 54.649,277.789 56.026 C 277.531 56.510,277.210 57.027,277.076 57.175 C 276.943 57.322,276.833 57.519,276.833 57.613 C 276.833 57.775,276.483 58.598,276.156 59.206 C 276.070 59.365,276.000 59.651,276.000 59.842 C 276.000 60.033,275.909 60.352,275.799 60.553 C 275.072 61.867,275.099 67.083,275.846 69.833 C 276.278 71.424,277.623 74.157,278.536 75.298 C 279.189 76.115,281.123 78.167,281.239 78.167 C 281.275 78.167,281.918 78.579,282.667 79.083 C 283.416 79.587,284.098 80.000,284.183 80.000 C 284.268 80.000,284.468 80.070,284.627 80.156 C 285.315 80.527,286.069 80.833,286.292 80.833 C 286.425 80.833,286.769 80.939,287.058 81.069 C 287.807 81.405,289.119 81.551,291.417 81.553 C 294.155 81.555,295.428 81.339,297.275 80.556 C 297.564 80.433,297.887 80.333,297.992 80.333 C 298.098 80.333,298.460 80.146,298.798 79.917 C 299.135 79.687,299.506 79.500,299.622 79.500 C 299.738 79.500,299.833 79.430,299.833 79.345 C 299.833 79.259,299.999 79.137,300.201 79.073 C 300.403 79.008,300.676 78.848,300.808 78.716 C 300.940 78.584,301.543 78.078,302.149 77.591 C 302.754 77.104,303.473 76.469,303.747 76.179 L 304.243 75.652 303.497 74.917 C 302.815 74.246,302.000 73.924,302.000 74.326 C 302.000 74.413,301.484 74.919,300.852 75.451 C 299.262 76.790,298.977 77.004,298.500 77.221 C 298.271 77.325,298.046 77.449,298.000 77.497 C 297.820 77.684,295.852 78.546,294.999 78.811 C 293.218 79.364,288.648 79.372,288.092 78.823 C 288.005 78.737,287.791 78.667,287.617 78.667 C 287.444 78.667,287.102 78.563,286.859 78.436 C 286.616 78.309,286.117 78.065,285.750 77.894 C 285.383 77.723,285.058 77.527,285.028 77.458 C 284.997 77.390,284.898 77.333,284.807 77.333 C 284.278 77.333,280.866 74.115,280.478 73.250 C 280.396 73.067,280.182 72.692,280.003 72.417 C 279.562 71.737,279.085 70.721,278.830 69.917 C 278.714 69.550,278.517 68.967,278.393 68.622 C 278.268 68.276,278.167 67.474,278.167 66.840 C 278.167 66.205,278.092 65.640,278.000 65.583 C 277.908 65.527,277.833 65.227,277.833 64.917 C 277.833 64.607,277.908 64.307,278.000 64.250 C 278.092 64.193,278.166 63.645,278.166 63.032 C 278.165 61.993,278.400 60.991,278.942 59.725 C 279.066 59.436,279.167 59.116,279.167 59.013 C 279.167 58.846,279.528 58.180,280.125 57.244 C 280.240 57.064,280.404 56.756,280.490 56.559 C 281.040 55.293,285.561 51.667,286.589 51.667 C 286.702 51.667,287.010 51.555,287.273 51.418 C 287.535 51.281,287.979 51.168,288.258 51.168 C 288.538 51.167,288.846 51.088,288.942 50.991 C 289.357 50.577,294.898 50.998,295.380 51.480 C 295.483 51.583,295.690 51.667,295.842 51.667 C 296.151 51.667,297.609 52.404,298.013 52.765 C 298.158 52.894,298.345 53.001,298.430 53.003 C 298.514 53.004,298.837 53.229,299.148 53.503 C 299.458 53.776,299.759 54.000,299.818 54.000 C 299.876 54.000,300.372 54.412,300.920 54.915 C 302.136 56.032,302.091 56.031,303.093 54.972 L 303.908 54.111 302.332 52.639 C 301.465 51.829,300.694 51.167,300.619 51.167 C 300.545 51.167,300.094 50.918,299.617 50.614 C 298.491 49.897,297.788 49.553,297.170 49.417 C 296.895 49.357,296.628 49.238,296.575 49.154 C 296.523 49.069,296.257 49.000,295.985 49.000 C 295.712 49.000,295.220 48.887,294.891 48.750 C 294.050 48.399,288.836 48.404,288.023 48.757 M323.417 48.756 C 323.142 48.882,322.677 48.988,322.385 48.992 C 322.092 48.997,321.812 49.067,321.761 49.148 C 321.711 49.230,321.463 49.344,321.210 49.401 C 320.780 49.499,318.017 50.811,317.833 51.004 C 317.642 51.205,316.362 52.167,316.286 52.167 C 315.645 52.167,311.864 57.378,311.839 58.294 C 311.836 58.410,311.766 58.635,311.684 58.794 C 310.698 60.702,310.167 65.454,310.674 67.833 C 310.762 68.246,310.907 68.990,310.996 69.488 C 311.086 69.985,311.236 70.469,311.329 70.563 C 311.423 70.657,311.500 70.861,311.500 71.018 C 311.500 71.274,312.128 72.697,312.522 73.333 C 312.607 73.471,312.720 73.715,312.774 73.875 C 312.828 74.035,312.933 74.167,313.008 74.167 C 313.083 74.167,313.195 74.328,313.258 74.526 C 313.498 75.283,316.263 78.090,317.542 78.875 C 318.028 79.173,318.573 79.511,318.754 79.626 C 318.935 79.741,319.196 79.880,319.333 79.935 C 319.471 79.989,319.947 80.214,320.390 80.433 C 320.834 80.653,321.361 80.833,321.562 80.833 C 321.762 80.833,322.075 80.938,322.258 81.066 C 323.494 81.932,330.193 81.648,332.206 80.644 C 332.365 80.565,332.590 80.499,332.706 80.498 C 333.627 80.487,336.424 78.638,338.407 76.729 C 339.329 75.841,340.729 73.901,341.098 73.000 C 341.154 72.862,341.380 72.387,341.600 71.943 C 341.820 71.499,342.000 71.060,342.000 70.968 C 342.000 70.876,342.107 70.564,342.237 70.275 C 342.367 69.986,342.513 69.487,342.561 69.167 C 342.609 68.846,342.723 68.208,342.814 67.750 C 343.019 66.723,343.028 63.378,342.829 62.250 C 342.568 60.770,342.374 59.929,342.155 59.333 C 341.727 58.169,340.511 55.741,340.176 55.382 C 339.988 55.180,339.833 54.948,339.833 54.867 C 339.833 53.845,334.270 49.753,332.403 49.403 C 332.088 49.344,331.789 49.229,331.738 49.148 C 331.688 49.066,331.473 49.000,331.261 49.000 C 331.048 49.000,330.605 48.887,330.276 48.750 C 329.462 48.410,324.162 48.415,323.417 48.756 M380.083 48.756 C 379.808 48.882,379.401 48.988,379.178 48.992 C 377.537 49.023,373.784 51.896,372.353 54.217 C 371.593 55.449,371.422 55.081,371.371 52.093 C 371.318 49.038,371.302 49.000,370.069 49.000 C 368.746 49.000,368.833 47.847,368.833 65.239 L 368.833 80.833 370.081 80.833 L 371.328 80.833 371.387 70.792 C 371.444 61.005,371.500 59.895,372.007 58.500 C 372.265 57.789,372.720 56.780,372.833 56.667 C 372.879 56.621,373.060 56.302,373.235 55.958 C 373.610 55.221,376.370 52.500,376.743 52.500 C 376.884 52.500,377.000 52.444,377.001 52.375 C 377.003 52.198,377.972 51.668,378.305 51.661 C 378.458 51.658,378.729 51.546,378.907 51.411 C 379.085 51.277,379.426 51.167,379.665 51.167 C 379.904 51.167,380.187 51.080,380.293 50.974 C 380.421 50.846,381.299 50.781,382.917 50.781 C 384.534 50.781,385.412 50.846,385.541 50.974 C 385.647 51.080,385.929 51.167,386.168 51.167 C 386.407 51.167,386.749 51.277,386.926 51.411 C 387.104 51.546,387.382 51.658,387.544 51.661 C 388.592 51.680,391.189 54.238,392.118 56.167 C 392.700 57.374,392.853 57.825,393.170 59.250 C 393.252 59.617,393.322 64.623,393.326 70.375 L 393.333 80.833 394.667 80.833 L 396.000 80.833 396.000 70.019 C 396.000 60.750,395.964 59.137,395.751 58.727 C 395.614 58.465,395.502 57.975,395.501 57.639 C 395.500 57.302,395.375 56.777,395.222 56.472 C 394.727 55.484,394.667 55.341,394.667 55.150 C 394.667 54.685,393.035 52.414,392.045 51.502 C 390.971 50.512,390.659 50.298,389.500 49.753 C 389.179 49.603,388.704 49.372,388.445 49.240 C 388.185 49.108,387.773 49.000,387.528 48.999 C 387.284 48.998,386.869 48.886,386.606 48.749 C 385.954 48.409,380.829 48.415,380.083 48.756 M353.749 49.200 C 353.705 49.319,353.649 56.485,353.626 65.125 L 353.583 80.833 354.793 80.833 L 356.002 80.833 355.959 64.958 L 355.917 49.083 354.873 49.034 C 354.132 48.998,353.806 49.047,353.749 49.200 M329.083 51.000 C 329.140 51.092,329.426 51.167,329.718 51.168 C 330.011 51.168,330.465 51.281,330.727 51.418 C 330.990 51.555,331.298 51.667,331.411 51.667 C 331.665 51.667,333.154 52.445,333.513 52.765 C 333.658 52.894,333.868 53.000,333.980 53.000 C 334.999 53.000,337.997 56.922,339.523 60.250 C 340.388 62.137,340.385 68.070,339.519 70.083 C 339.094 71.068,338.250 72.649,337.900 73.114 C 337.680 73.406,337.500 73.713,337.500 73.798 C 337.500 73.996,334.678 76.833,334.480 76.833 C 334.398 76.833,334.020 77.058,333.640 77.333 C 333.261 77.608,332.849 77.833,332.725 77.833 C 332.601 77.833,332.500 77.908,332.500 78.000 C 332.500 78.092,332.364 78.167,332.199 78.167 C 332.033 78.167,331.751 78.277,331.574 78.411 C 331.396 78.546,331.059 78.658,330.825 78.661 C 330.591 78.664,330.326 78.740,330.237 78.830 C 329.700 79.367,324.138 79.361,323.592 78.823 C 323.505 78.737,323.263 78.667,323.056 78.667 C 322.704 78.667,322.309 78.522,320.833 77.854 C 320.512 77.709,319.899 77.307,319.470 76.962 C 319.041 76.616,318.629 76.333,318.553 76.333 C 318.095 76.331,315.380 72.967,314.838 71.729 C 313.918 69.630,313.667 68.908,313.667 68.363 C 313.667 68.108,313.583 67.816,313.480 67.714 C 313.359 67.592,313.294 66.618,313.294 64.917 C 313.294 63.215,313.359 62.241,313.480 62.120 C 313.583 62.017,313.667 61.705,313.668 61.425 C 313.668 61.145,313.781 60.702,313.918 60.439 C 314.055 60.177,314.169 59.839,314.172 59.689 C 314.175 59.539,314.287 59.271,314.422 59.093 C 314.557 58.915,314.667 58.660,314.667 58.526 C 314.667 58.391,314.854 58.036,315.083 57.735 C 315.313 57.435,315.500 57.143,315.500 57.087 C 315.500 56.226,319.935 52.167,320.877 52.167 C 321.014 52.167,321.219 52.054,321.333 51.917 C 321.447 51.779,321.700 51.664,321.895 51.661 C 322.090 51.658,322.438 51.548,322.667 51.417 C 322.896 51.286,323.285 51.176,323.532 51.173 C 323.779 51.169,324.027 51.092,324.083 51.000 C 324.144 50.901,325.165 50.833,326.583 50.833 C 328.002 50.833,329.022 50.901,329.083 51.000 M252.583 54.742 C 253.685 54.999,255.175 55.726,255.662 56.245 C 255.880 56.477,256.120 56.667,256.196 56.667 C 256.525 56.667,257.997 58.647,258.425 59.667 C 260.661 64.992,258.767 70.892,254.087 73.181 C 252.697 73.861,249.125 74.017,248.083 73.444 C 247.808 73.293,247.490 73.168,247.375 73.168 C 247.260 73.167,247.167 73.100,247.167 73.018 C 247.167 72.936,246.994 72.826,246.783 72.773 C 245.880 72.547,243.167 69.374,243.167 68.545 C 243.167 68.378,243.064 68.093,242.937 67.912 C 242.242 66.914,242.274 61.159,242.980 60.453 C 243.083 60.351,243.167 60.138,243.167 59.980 C 243.167 58.460,247.172 54.833,248.850 54.833 C 249.105 54.833,249.363 54.753,249.424 54.655 C 249.540 54.467,251.655 54.525,252.583 54.742 \" stroke=\"none\" fill=\"#fbfbfb\" fill-rule=\"evenodd\"></path></g></svg>\n"
            + "\t</div>"
            + "\t<h1>Checkout</h1>\r\n";
        String message = "<p>Cannot find the order<p/>";
        MoOrder order;

        try {
            boolean isUuid = orderId.startsWith("ord_");
            String orderUuid;
            if (isUuid) {
                orderUuid = orderId.substring(4);
                order = crossStorageApi.find(defaultRepo, orderUuid, MoOrder.class);
            } else {
                order = crossStorageApi.find(defaultRepo, MoOrder.class)
                                       .by("orderNumber", orderId)
                                       .getResult();
                orderUuid = order.getUuid();
            }
            String normalizedId = "ord_" + orderUuid;
            Map<String, String> metadata = convert(order.getMetadata());
            String partnerId = metadata.get("partnerId");
            String partnerIdQuery = partnerId != null ? "?pid=" + partnerId : "";

            if ("created".equals(order.getStatus())) {
                message =
                    "\t<div>To pay your order, please scan this QR-code<br/> using your " + APP_NAME + " mobile app</div><br/>\r\n"
                        + "\t<canvas id=\"qr-code\"></canvas>\r\n"
                        + "\t<script src=\"https://cdnjs.cloudflare.com/ajax/libs/qrious/4.0.2/qrious.min.js\"></script>\r\n"
                        + "\t<script>\r\n"
                        + "\tvar qr;\r\n"
                        + "\t(function() {\r\n"
                        + "\tqr = new QRious({\r\n"
                        + "\telement: document.getElementById('qr-code'),\r\n"
                        + "\tsize: 200,\r\n"
                        + "\tvalue: \"https://link.klubcoin.net/payment/" + normalizedId + partnerIdQuery + "\"});\r\n"
                        + "\tqr.set({foreground: 'black',size: 200});\r\n"
                        + "\t})();\r\n"
                        + "\t</script>\r\n"
                        + "\t<script>\n"
                        + "\t\t(function () {\n"
                        + "\t\t\tconst pathname = window.location.pathname;\n"
                        + "\t\t\tconst context = pathname.substring(0, pathname.indexOf(\"/\", 1));\n"
                        + "\t\t\tconst getPaymentStatus = async (orderId) => {\n"
                        + "\t\t\t\tconst url = window.location.origin + context + \"/rest/pg/v1/paymentStatus/\" + orderId;\n"
                        + "\t\t\t\tconst response = await fetch(url);\n"
                        + "\t\t\t\tconst json = await response.json();\n"
                        + "\t\t\t\treturn json.status;\n"
                        + "\t\t\t};\n"
                        + "\t\t\tconst checkPaymentStatus = async (orderId) => {\n"
                        + "\t\t\t\tconst status = await getPaymentStatus(orderId);\n"
                        + "\t\t\t\tif (status === \"paid\" || status === \"canceled\" || status === \"expired\") {\n"
                        + "\t\t\t\t\tconst validateUrl = window.location.origin + context + \"/rest/validate-payment/\" + orderId;\n"
                        + "\t\t\t\t\tconst validateResponse = await fetch(validateUrl);\n"
                        + "\t\t\t\t\tconst validateResult = await validateResponse.json();\n"
                        + "\t\t\t\t\tif (\"success\" === validateResult.status) {\n"
                        + "\t\t\t\t\t\twindow.location.href = \"" + order.getRedirectUrl() + "\";\n"
                        + "\t\t\t\t\t}\n"
                        + "\t\t\t\t} else {\n"
                        + "\t\t\t\t\tsetTimeout(() => {\n"
                        + "\t\t\t\t\t\tcheckPaymentStatus(\"" + normalizedId + "\");\n"
                        + "\t\t\t\t\t}, 15000);\n"
                        + "\t\t\t\t}\n"
                        + "\t\t\t};\n"
                        + "\t\t\tcheckPaymentStatus(\"" + normalizedId + "\");\n"
                        + "\t\t})();\n"
                        + "\t</script>";
            } else {
                message = "<p>Invalid order<p/>";
            }
        } catch (Exception e) {
            e.printStackTrace();
        }
        result += message
            + "\t</section></body>\r\n"
            + "\t</html>\r\n";
    }

    public static <T> T convert(String data) {
        T value = null;
        try {
            value = mapper.readValue(data, new TypeReference<T>() {
            });
        } catch (Exception e) {
            LOG.error("Failed to parse data: {}", data, e);
        }
        return value;
    }
}
